<!doctype html>
<html>
<head lang="en">
    <title>Flags</title>

    <link
        rel="stylesheet"
        href="style.css">
</head>

<body class="homey-widget-full">

<div id="flags"></div>

<script type="text/javascript">
    function onHomeyReady(Homey) {
        const settings = Homey.getSettings();

        let lastResult = null;
        let ready = false;

        async function init() {
            Homey.on('flowbits-flags-update', update);

            await update();
        }

        async function onClickFlag(flag) {
            try {
                Homey.hapticFeedback();
            } catch (_) {
                // care
            }

            await Homey.api('POST', '/', {flag: flag.name});
        }

        async function update() {
            const results = await Homey.api('GET', '/');
            let elements = [];

            const resultsString = JSON.stringify(results);

            if (lastResult === resultsString) {
                return;
            }

            lastResult = resultsString;

            for (const result of results) {
                if (settings.filter && settings.filter.flags.length > 0 && !settings.filter.flags.includes(result.name)) {
                    continue;
                }

                const button = document.createElement('button');
                button.className = 'homey-widget item' + (result.active ? ' active' : '');
                button.addEventListener('click', () => onClickFlag(result));

                if (settings.show_icons && result.icon) {
                    const icon = document.createElement('div');
                    icon.className = 'flowbits-icon item-icon';
                    icon.style.setProperty('--color', result.color);
                    icon.style.setProperty('--icon', JSON.stringify(result.icon));
                    icon.style.setProperty('--icon-secondary', JSON.stringify(result.icon + result.icon));
                    button.appendChild(icon);
                }

                const caption = document.createElement('div');
                caption.className = 'item-caption';
                button.appendChild(caption);

                const name = document.createElement('p');
                name.className = 'homey-text-medium';
                name.textContent = result.name;
                caption.appendChild(name);

                elements.push(button);
            }

            const flags = document.getElementById('flags');

            if (settings.readonly) {
                flags.setAttribute('data-readonly', 'true');
            } else {
                flags.removeAttribute('data-readonly');
            }

            if (settings.view_mode === 'grid') {
                flags.className = 'grid';
            } else {
                flags.className = 'list';
            }

            flags.innerText = '';
            elements.forEach(element => flags.appendChild(element));

            const height = flags.getBoundingClientRect().height;

            if (ready) {
                await Homey.setHeight(height);
            } else {
                Homey.ready({height});
                ready = true;
            }
        }

        init();
    }
</script>

</body>
</html>
