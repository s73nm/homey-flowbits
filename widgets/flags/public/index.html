<!doctype html>
<html>
<head lang="en">
    <title>Flags</title>
    <style>
        body {
            -webkit-tap-highlight-color: rgb(0 0 0 / 0.00001);
            -webkit-user-select: none;
            user-select: none;
        }

        .grid,
        .list {
            display: grid;
            gap: 1px;
            grid-auto-rows: 1fr;
            background: var(--homey-color-mono-025);
        }

        .grid {
            grid-template-columns: 1fr 1fr;

            &:has(> .item:last-child:nth-child(odd)) {
                &::after {
                    display: flex;
                    content: '';
                    background: var(--homey-background-color);
                }
            }
        }

        .list {
            grid-template-columns: 1fr;
        }

        .homey-dark-mode .grid {
            background: var(--homey-color-mono-100);
        }

        .item {
            display: flex;
            align-items: center;
            flex-flow: row;
            justify-content: start;
            gap: var(--homey-su-3);
            background: var(--homey-background-color);
            border: 0;
            line-height: 1;
            outline: 0;
            overflow: hidden;
            text-align: left;
            transition: 150ms cubic-bezier(0.55, 0, 0.1, 1);
            transition-property: background, border-radius, scale;
            will-change: transform;
        }

        .item:active {
            background: rgb(from var(--homey-background-color) r g b / .5);
            border-radius: var(--homey-border-radius-default);
            scale: 0.975;
        }

        .item-caption {
            display: flex;
            align-items: stretch;
            flex-flow: column;
            flex-grow: 1;
            flex-shrink: 1;
            overflow: hidden;
        }

        .item-caption .homey-text-medium {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .item-icon {
            --color: #64748b;
            --icon: url(shapes.svg);

            display: flex;
            height: 24px;
            margin: -3px;
            width: 24px;
            align-items: center;
            flex-shrink: 0;
            justify-content: center;
            background: var(--color);
            -webkit-mask-image: var(--icon);
            -webkit-mask-position: center;
            -webkit-mask-repeat: no-repeat;
            -webkit-mask-size: 42px 42px;
            mask-image: var(--icon);
            mask-position: center;
            mask-repeat: no-repeat;
            mask-size: 24px 24px;
        }

        .homey-custom-icon-check {
            --homey-icon-color: var(--homey-icon-color-green);
            --homey-icon-size: 24px;

            flex-shrink: 0;
            -webkit-mask-image: url(check.svg);
            mask-image: url(check.svg);
        }
    </style>
</head>

<body class="homey-widget-full">

<div id="flags"></div>

<script type="text/javascript">
    function onHomeyReady(Homey) {
        const settings = Homey.getSettings();

        let lastResult = null;
        let ready = false;

        async function init() {
            Homey.on('flowbits-flags-update', update);

            await update();
        }

        async function onClickFlag(flag) {
            Homey.hapticFeedback();
            await Homey.api('POST', '/', {flag: flag.name});
        }

        async function update() {
            const results = await Homey.api('GET', '/');
            let elements = [];

            const resultsString = JSON.stringify(results);

            if (lastResult === resultsString) {
                return;
            }

            lastResult = resultsString;

            for (const result of results) {
                const button = document.createElement('button');
                button.className = 'homey-widget item';
                button.onclick = () => onClickFlag(result);

                if (settings.show_icons && result.icon) {
                    const icon = document.createElement('div');
                    icon.className = 'item-icon';
                    icon.style.setProperty('--color', result.icon.color);
                    icon.style.setProperty('--icon', `url(${result.icon.url})`);
                    button.appendChild(icon);
                }

                const caption = document.createElement('div');
                caption.className = 'item-caption';
                button.appendChild(caption);

                const name = document.createElement('p');
                name.className = 'homey-text-medium';
                name.textContent = result.name;
                caption.appendChild(name);

                if (result.active) {
                    const icon = document.createElement('div');
                    icon.className = 'homey-custom-icon-check';
                    button.appendChild(icon);
                }

                elements.push(button);
            }

            const flags = document.getElementById('flags');

            if (settings.view_mode === 'grid') {
                flags.className = 'grid';
            } else {
                flags.className = 'list';
            }

            flags.innerHTML = '';
            elements.forEach(element => flags.appendChild(element));

            const height = flags.getBoundingClientRect().height;

            if (ready) {
                await Homey.setHeight(height);
            } else {
                Homey.ready({height});
                ready = true;
            }
        }

        init();
    }
</script>

</body>
</html>
