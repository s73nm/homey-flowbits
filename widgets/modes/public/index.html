<!doctype html>
<html>
<head lang="en">
    <title>Modes</title>

    <link
        rel="stylesheet"
        href="style.css">
</head>

<body class="homey-widget-full">

<div id="modes"></div>

<script type="text/javascript">
    function onHomeyReady(Homey) {
        const settings = Homey.getSettings();

        let lastResult = null;
        let ready = false;

        async function init() {
            Homey.on('flowbits-mode-update', update);

            await update();
        }

        async function onClickMode(mode) {
            Homey.hapticFeedback();
            await Homey.api('POST', '/', {mode: mode.name});
        }

        async function update() {
            const results = await Homey.api('GET', '/');
            let elements = [];

            const resultsString = JSON.stringify(results);

            if (lastResult === resultsString) {
                return;
            }

            lastResult = resultsString;

            for (const result of results) {
                const button = document.createElement('button');
                button.className = 'homey-widget item' + (result.active ? ' active' : '');
                button.onclick = () => onClickMode(result);

                if (settings.show_icons && result.icon) {
                    const icon = document.createElement('div');
                    icon.className = 'flowbits-icon item-icon';
                    icon.style.setProperty('--color', result.color);
                    icon.style.setProperty('--icon', JSON.stringify(result.icon));
                    icon.style.setProperty('--icon-secondary', JSON.stringify(result.icon + result.icon));
                    button.appendChild(icon);
                }

                const caption = document.createElement('div');
                caption.className = 'item-caption';
                button.appendChild(caption);

                const name = document.createElement('p');
                name.className = 'homey-text-medium';
                name.textContent = result.name;
                caption.appendChild(name);

                elements.push(button);
            }

            const modes = document.getElementById('modes');

            if (settings.readonly) {
                modes.setAttribute('data-readonly', 'true');
            } else {
                modes.removeAttribute('data-readonly');
            }

            if (settings.view_mode === 'grid') {
                modes.className = 'grid';
            } else {
                modes.className = 'list';
            }

            modes.innerHTML = '';
            elements.forEach(element => modes.appendChild(element));

            const height = modes.getBoundingClientRect().height;

            if (ready) {
                await Homey.setHeight(height);
            } else {
                Homey.ready({height});
                ready = true;
            }
        }

        init();
    }
</script>

</body>
</html>
