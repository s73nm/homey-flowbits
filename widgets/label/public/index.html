<!doctype html>
<html>
<head lang="en">
    <title>Label</title>

    <link
        rel="stylesheet"
        href="style.css">
</head>

<body class="homey-widget">

<div class="basic-widget">
    <div
        class="basic-widget-icon flowbits-icon"
        id="label-icon"></div>

    <div class="basic-widget-caption">
        <div class="basic-widget-header">
            <span
                class="basic-widget-header-name"
                id="label-name">&mdash;</span>

            <span
                class="basic-widget-header-icon flowbits-icon"
                style="--icon: ''; --icon-secondary: ''"></span>
        </div>

        <div
            class="basic-widget-content"
            id="label-value">
            &mdash;
        </div>
    </div>
</div>

<script type="text/javascript">
    function onHomeyReady(Homey) {
        const labelIcon = document.getElementById('label-icon');
        const labelName = document.getElementById('label-name');
        const labelValue = document.getElementById('label-value');
        let ready = false;

        const settings = Homey.getSettings();

        async function init() {
            Homey.on('flowbits-labels-update', update);

            await update();
        }

        async function update() {
            const label = await Homey.api('GET', `/?label=${settings.label.name}`);

            labelName.innerText = label?.name ?? '—';
            labelValue.innerText = label?.value ?? '—';

            if (label?.color) {
                labelIcon.style.setProperty('--color', label.color);
            } else {
                labelIcon.style.removeProperty('--color');
            }

            if (label?.icon) {
                labelIcon.style.setProperty('--icon', JSON.stringify(label.icon));
                labelIcon.style.setProperty('--icon-secondary', JSON.stringify(label.icon + label.icon));
            } else {
                labelIcon.style.removeProperty('--icon');
                labelIcon.style.removeProperty('--icon-secondary');
            }

            const height = document.body.getBoundingClientRect().height;

            if (ready) {
                await Homey.setHeight(height);
            } else {
                Homey.ready({height});
                ready = true;
            }
        }

        init();
    }
</script>

</body>
</html>
