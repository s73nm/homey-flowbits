<!doctype html>
<html>
<head lang="en">
    <title>Current mode</title>

    <link
        rel="stylesheet"
        href="style.css">
</head>

<body class="homey-widget-full">

<div class="mount">
    <div class="name homey-text-bold"></div>

    <div class="slider">
        <div class="slider-value">
            <div class="slider-knob"></div>
        </div>
        <div class="flowbits-icon slider-icon start"></div>
        <div class="flowbits-icon slider-icon end"></div>
    </div>
</div>

<script type="text/javascript">
    function onHomeyReady(Homey) {
        const formatter = new Intl.NumberFormat(navigator.language, {minimumFractionDigits: 0, maximumFractionDigits: 1, style: 'percent'});
        const settings = Homey.getSettings();

        /** @type HTMLElement */
        const mount = document.querySelector('.mount');
        /** @type HTMLElement */
        const name = document.querySelector('.name');
        /** @type HTMLElement */
        const slider = document.querySelector('.slider');

        async function init() {
            name.innerText = settings.slider.name;

            let icon = settings.icon.unicode;
            if (icon.startsWith('"')) {
                icon = JSON.parse(icon);
            }

            slider.style.setProperty('--slider-color', `var(--${settings.color})`);
            slider.style.setProperty('--slider-icon', JSON.stringify(icon));
            slider.style.setProperty('--slider-icon-secondary', JSON.stringify(icon + icon));

            let active = false;

            slider.addEventListener('pointerdown', e => {
                active = true;
                slider.setPointerCapture(e.pointerId);
                slider.classList.add('active');

                setValue(e.clientX);

                e.preventDefault();
                e.stopPropagation();
            });

            slider.addEventListener('pointermove', e => {
                if (!active) {
                    return;
                }

                setValue(e.clientX);

                e.preventDefault();
                e.stopPropagation();
            });

            slider.addEventListener('pointerup', e => {
                active = false;
                slider.releasePointerCapture(e.pointerId);
                slider.classList.remove('active');

                setValue(e.clientX, true);

                e.preventDefault();
                e.stopPropagation();
            });

            await update();

            Homey.on('flowbits-slider-update', onUpdate);
            Homey.ready({height: mount.getBoundingClientRect().height});
        }

        async function setValue(clientX, push = false) {
            const rect = slider.getBoundingClientRect();
            const x = Math.min(Math.max(clientX - rect.left, 0), rect.width);
            const ratio = x / rect.width;
            const v = Math.round(ratio * 100);

            await setValueRaw(v);

            if (push) {
                await Homey.api('POST', `/?slider=${settings.slider.name}`, {value: v});
            }
        }

        async function setValueRaw(value) {
            slider.style.setProperty('--slider-value', String(value));
            name.innerText = `${settings.slider.name}: ${formatter.format(value / 100)}`;

            if (value >= 15) {
                slider.classList.remove('low');
            } else {
                slider.classList.add('low');
            }
        }

        async function update() {
            const value = await Homey.api('GET', `/?slider=${settings.slider.name}`);
            await setValueRaw(value);
        }

        async function onUpdate(event) {
            if (event.slider !== settings.slider.name) {
                return;
            }

            if (event.widgetId === Homey.getWidgetInstanceId()) {
                return;
            }

            await setValueRaw(event.value);
        }

        init();
    }
</script>

</body>
</html>
