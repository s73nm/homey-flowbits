<!doctype html>
<html>
<head lang="en">
    <title>Flag on/off</title>
    <style>
        body {
            -webkit-tap-highlight-color: rgb(0 0 0 / 0.00001);
            -webkit-user-select: none;
            user-select: none;
        }

        .flag-on-off {
            display: flex;
            padding: var(--homey-su-4);
            align-items: center;
            flex-flow: row;
            gap: var(--homey-su-3);
            justify-content: start;
        }

        .flag-on-off-name {
            flex-grow: 1;
        }

        .flag-on-off-power {
            --homey-icon-color: var(--homey-color-mono-400);

            display: flex;
            height: 48px;
            width: 48px;
            align-items: center;
            justify-content: center;
            background: var(--homey-color-mono-050);
            border: 0;
            border-radius: 24px;
            transition: 150ms cubic-bezier(0.55, 0, 0.1, 1);
            transition-property: background, scale;
            -webkit-user-select: none;
            user-select: none;
            will-change: transform;
        }

        .homey-dark-mode .flag-on-off-power {
            --homey-icon-color: var(--homey-color-mono-600);

            background: var(--homey-color-mono-200);
        }

        .flag-on-off-power.on,
        .homey-dark-mode .flag-on-off-power.on {
            --homey-icon-color: white;

            background: var(--homey-icon-color-green);
        }

        .flag-on-off-power:active {
            background: rgb(from var(--homey-color-mono-200) r g b / .5);
            scale: 0.95;
        }

        .homey-dark-mode .flag-on-off-power:active {
            background: rgb(from var(--homey-color-mono-300) r g b / .5);
            scale: 0.95;
        }

        .flag-on-off-icon {
            --color: #64748b;
            --icon: url(shapes.svg);

            display: flex;
            height: 42px;
            width: 42px;
            align-items: center;
            justify-content: center;
            border-radius: 24px;
            background: var(--color);
            -webkit-mask-image: var(--icon);
            -webkit-mask-position: center;
            -webkit-mask-repeat: no-repeat;
            -webkit-mask-size: 42px 42px;
            mask-image: var(--icon);
            mask-position: center;
            mask-repeat: no-repeat;
            mask-size: 42px 42px;
        }

        .flag-on-off-icon:not(.on) {
            --color: var(--homey-color-mono-200) !important;
        }

        .homey-custom-icon-power {
            --homey-icon-size: 24px;

            -webkit-mask-image: url(power.svg);
            mask-image: url(power.svg);
        }
    </style>
</head>

<body class="homey-widget-full">

<div
    class="flag-on-off"
    id="flag-on-off">
    <div class="flag-on-off-icon"></div>

    <strong class="homey-text-bold flag-on-off-name"></strong>

    <button class="flag-on-off-power">
        <div class="homey-custom-icon-power"></div>
    </button>
</div>

<script type="text/javascript">
    function onHomeyReady(Homey) {
        const onoff = document.getElementById('flag-on-off');
        const name = onoff.getElementsByClassName('flag-on-off-name')[0];
        const icon = onoff.getElementsByClassName('flag-on-off-icon')[0];
        const power = onoff.getElementsByClassName('flag-on-off-power')[0];

        let loading = false;
        let ready = false;

        const settings = Homey.getSettings();

        async function init() {
            Homey.on('flowbits-flags-update', update);

            await update();

            power.addEventListener('click', async () => {
                const flag = settings.flag.name;

                if (loading) {
                    return;
                }

                loading = true;

                Homey.hapticFeedback();

                if (power.classList.contains('on')) {
                    icon.classList.remove('on');
                    power.classList.remove('on');
                } else {
                    icon.classList.add('on');
                    power.classList.add('on');
                }

                await Homey.api('POST', '/', {flag});

                loading = false;
            }, {passive: true});
        }

        async function update() {
            const flag = settings.flag.name;
            name.innerHTML = flag;

            const state = await Homey.api('GET', `/?flag=${flag}`);

            if (state.active) {
                icon.classList.add('on');
                power.classList.add('on');
            } else {
                icon.classList.remove('on');
                power.classList.remove('on');
            }

            if (state?.icon) {
                icon.style.setProperty('--color', state.icon.color);
                icon.style.setProperty('--icon', `url(${state.icon.url})`);
            } else {
                icon.style.removeProperty('--color');
                icon.style.removeProperty('--icon');
            }

            const height = onoff.getBoundingClientRect().height;

            if (ready) {
                await Homey.setHeight(height);
            } else {
                Homey.ready({height});
                ready = true;
            }
        }

        init();
    }
</script>

</body>
</html>
