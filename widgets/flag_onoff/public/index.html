<!doctype html>
<html>
<head lang="en">
    <title>Flag on/off</title>

    <link
        rel="stylesheet"
        href="style.css">
</head>

<body class="homey-widget-full">

<div
    class="flag-on-off"
    id="flag-on-off">
    <div class="flag-on-off-icon"></div>

    <strong class="homey-text-bold flag-on-off-name"></strong>

    <button class="flag-on-off-power">ï€‘</button>
</div>

<script type="text/javascript">
    function onHomeyReady(Homey) {
        /** @type HTMLElement */
        const onoff = document.getElementById('flag-on-off');
        /** @type HTMLElement */
        const name = onoff.getElementsByClassName('flag-on-off-name')[0];
        /** @type HTMLElement */
        const icon = onoff.getElementsByClassName('flag-on-off-icon')[0];
        /** @type HTMLElement */
        const power = onoff.getElementsByClassName('flag-on-off-power')[0];

        let loading = false;
        let ready = false;

        const settings = Homey.getSettings();

        async function init() {
            Homey.on('flowbits-flags-update', update);

            await update();

            power.addEventListener('click', async () => {
                const flag = settings.flag.name;

                if (loading) {
                    return;
                }

                loading = true;

                Homey.hapticFeedback();

                if (power.classList.contains('on')) {
                    icon.classList.remove('on');
                    power.classList.remove('on');
                } else {
                    icon.classList.add('on');
                    power.classList.add('on');
                }

                await Homey.api('POST', '/', {flag});

                loading = false;
            }, {passive: true});
        }

        async function update() {
            const flag = settings.flag.name;
            name.innerHTML = flag;

            const state = await Homey.api('GET', `/?flag=${flag}`);

            if (state.active) {
                icon.classList.add('on');
                power.classList.add('on');
            } else {
                icon.classList.remove('on');
                power.classList.remove('on');
            }

            if (state?.color) {
                icon.style.setProperty('--color', state.color);
            } else {
                icon.style.removeProperty('--color');
            }

            if (state?.icon) {
                icon.style.setProperty('--icon', JSON.stringify(state.icon));
                icon.style.setProperty('--icon-secondary', JSON.stringify(state.icon + state.icon));
            } else {
                icon.style.removeProperty('--icon');
                icon.style.removeProperty('--icon-secondary');
            }

            const height = onoff.getBoundingClientRect().height;

            if (ready) {
                await Homey.setHeight(height);
            } else {
                Homey.ready({height});
                ready = true;
            }
        }

        init();
    }
</script>

</body>
</html>
